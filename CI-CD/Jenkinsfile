pipeline {
    agent any
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –¥–ª—è –ø–∞–π–ø–ª–∞–π–Ω–∞
    environment {
        // –ß—Ç–æ–±—ã Python –Ω–µ –±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–ª –≤—ã–≤–æ–¥ (—Å—Ä–∞–∑—É –≤–∏–¥–µ–ª –ª–æ–≥–∏)
        PYTHONUNBUFFERED = '1' 
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup Python Environment') {
            steps {
                sh '''
                    echo "üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
                    python3 --version
                    
                    # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    if [ ! -d "venv" ]; then
                        python3 -m venv venv
                    fi
                '''
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh '''
                    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º venv –∏ —Å—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                    # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º pytest, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ requirements.txt
                    pip install pytest
                '''
            }
        }
        
        stage('Run Tests') {
            steps {
                sh '''
                    . venv/bin/activate
                    echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ pytest..."
                    
                    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
                    mkdir -p reports
                    
                    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π XML –æ—Ç—á–µ—Ç–∞ –¥–ª—è Jenkins
                    python3 -m pytest tests/Test* --verbose --junitxml=reports/junit.xml
                '''
            }
            post {
                always {
                    // Jenkins —Å—á–∏—Ç–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
                    junit 'reports/junit.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            when {
                branch 'main'
            }
            steps {
                script {
                    echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
                    sh 'docker build -t Scalar:${BUILD_ID} .'
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞
                    sh '''
                        if docker images | grep -q "Scalar"; then
                            echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω"
                        else
                            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('Test Docker Image') {
            when {
                branch 'main'
            }
            steps {
                script {
                    echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º Docker –æ–±—Ä–∞–∑..."
                    sh '''
                        # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –æ—Å—Ç–∞–ª—Å—è
                        docker rm -f scalar-test || true

                        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        docker run -d --name scalar-test Scalar:${BUILD_ID}
                        
                        sleep 5
                        
                        if docker ps | grep -q "scalar-test"; then
                            echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
                            docker logs scalar-test
                            docker stop scalar-test
                            docker rm scalar-test
                        else
                            echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–ø–∞–ª"
                            docker logs scalar-test || true
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        // –≠—Ç–∞–ø –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –µ—Å—Ç—å, –æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, —Ç–æ–ª—å–∫–æ —É–±–µ–¥–∏—Å—å —á—Ç–æ credentials —Å–æ–∑–¥–∞–Ω—ã –≤ Jenkins)
        stage('Push to Registry') {
            when {
                branch 'main'
            }
            steps {
                script {
                    // –í–ê–ñ–ù–û: –¢–µ–±–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å credentials —Å ID 'docker-hub' –≤ Jenkins UI
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh '''
                            echo "üì¶ –ü—É–±–ª–∏–∫–∞—Ü–∏—è..."
                            # –õ–æ–≥–∏–Ω –∏ –ø—É—à
                            echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                            
                            docker tag Scalar:${BUILD_ID} $DOCKER_USER/Scalar:latest
                            docker tag Scalar:${BUILD_ID} $DOCKER_USER/Scalar:${BUILD_ID}
                            
                            docker push $DOCKER_USER/Scalar:latest
                            docker push $DOCKER_USER/Scalar:${BUILD_ID}
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'üìä –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'
            // –ß–∏—Å—Ç–∏–º –º–µ—Å—Ç–æ. || true –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –æ—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –Ω–µ –≤–∞–ª–∏–ª–∞ –≤–µ—Å—å –±–∏–ª–¥
            sh 'docker system prune -f || true'
        }
        // –ë–ª–æ–∫–∏ success/failure —Å emailext —Å—Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–ª–∞–≥–∏–Ω Email Extension
    }
}