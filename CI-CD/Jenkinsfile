// ... (–Ω–∞—á–∞–ª–æ Jenkinsfile)

pipeline {
    agent any
    
    environment {
        PYTHONUNBUFFERED = '1' 
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –ø–∞–ø–∫–∏, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
        PROJECT_DIR = 'CI-CD' // <--- –ó–ê–ú–ï–ù–ò –≠–¢–û –ù–ê –ò–ú–Ø –¢–í–û–ï–ô –ü–ê–ü–ö–ò
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ —Å—Ç–∞–¥–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –∫–æ–¥–æ–º, –≤ dir()
        stage('Project CI/CD') {
            steps {
                dir("${PROJECT_DIR}") {
                    
                    // –í—Å–µ —à–∞–≥–∏ –≤–Ω—É—Ç—Ä–∏ dir() —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∏–∑ –ø–∞–ø–∫–∏ 'app-repo-folder'
                    
                    stage('Setup Python Environment') {
                        steps {
                            sh '''
                                echo "üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
                                python3 --version
                                
                                if [ ! -d "venv" ]; then
                                    python3 -m venv venv
                                fi
                            '''
                        }
                    }
                    
                    stage('Install Dependencies') {
                        steps {
                            // –ü—É—Ç—å –∫ requirements.txt —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
                            sh '''
                                . venv/bin/activate
                                pip install --upgrade pip
                                pip install -r requirements.txt
                                pip install pytest
                            '''
                        }
                    }
                    
                    stage('Run Tests') {
                        steps {
                            // –ü—É—Ç—å –∫ tests/ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
                            sh '''
                                . venv/bin/activate
                                echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ pytest..."
                                
                                mkdir -p reports
                                
                                # –û—Ç—á–µ—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ reports/ –≤–Ω—É—Ç—Ä–∏ PROJECT_DIR
                                python3 -m pytest tests/ --verbose --junitxml=reports/junit.xml
                            '''
                        }
                        post {
                            always {
                                // –ü—É—Ç—å –∫ –æ—Ç—á–µ—Ç—É –¥–ª—è JUnit –ø–ª–∞–≥–∏–Ω–∞
                                junit "${PROJECT_DIR}/reports/junit.xml" 
                            }
                        }
                    }
                    
                    stage('Build Docker Image') {
                        when {
                            branch 'main'
                        }
                        steps {
                            script {
                                echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
                                // 'docker build .' —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ø–∞–ø–∫–∏ 'app-repo-folder'
                                sh 'docker build -t Scalar:${BUILD_ID} .'
                                
                                // –ü—Ä–æ–≤–µ—Ä–∫–∞ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
                                sh '''
                                    if docker images | grep -q "Scalar"; then
                                        echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω"
                                    else
                                        echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞"
                                        exit 1
                                    fi
                                '''
                            }
                        }
                    }
                    
                    // ... (–û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞–¥–∏–∏ Test Docker Image, Push to Registry, Deploy Notification) 
                    // ... (–ò—Ö —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä—å –±–ª–æ–∫–∞ dir, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)
                    
                    stage('Test Docker Image') {
                        // ... (—Ç–µ–ª–æ —Å—Ç–∞–¥–∏–∏)
                    }
                    
                    stage('Push to Registry') {
                        // ... (—Ç–µ–ª–æ —Å—Ç–∞–¥–∏–∏)
                    }
                    
                    stage('Deploy Notification') {
                        // ... (—Ç–µ–ª–æ —Å—Ç–∞–¥–∏–∏)
                    }
                } // <--- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê dir("${PROJECT_DIR}")
            }
        }
    }
    
    // ... (–ø–æ—Å—Ç-–¥–µ–π—Å—Ç–≤–∏—è)
    post {
        // ...
        always {
            echo 'üìä –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'
            sh 'docker system prune -f || true'
        }
    }
}