pipeline {
    agent any
    
    environment {
        PYTHONUNBUFFERED = '1' 
        PROJECT_DIR = 'app-repo-folder' // <--- ÐŸÐ ÐžÐ’Ð•Ð Ð¬ Ð­Ð¢Ðž Ð˜ÐœÐ¯!
    }
    
    stages {
        
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup Python Environment') {
            steps {
                dir("${PROJECT_DIR}") { // <-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ dir()
                    sh '''
                        echo "ðŸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
                        python3 --version
                        
                        if [ ! -d "venv" ]; then
                            python3 -m venv venv
                        fi
                    '''
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                dir("${PROJECT_DIR}") { // <-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ dir()
                    sh '''
                        . venv/bin/activate
                        pip install --upgrade pip
                        pip install -r requirements.txt
                        pip install pytest
                    '''
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                dir("${PROJECT_DIR}") { // <-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ dir()
                    sh '''
                        . venv/bin/activate
                        echo "ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· pytest..."
                        
                        mkdir -p reports
                        
                        python3 -m pytest tests/ --verbose --junitxml=reports/junit.xml
                    '''
                }
            }
            post {
                always {
                    // ÐŸÑƒÑ‚ÑŒ Ðº Ð¾Ñ‚Ñ‡ÐµÑ‚Ñƒ Ð¾ÑÑ‚Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼
                    junit "${PROJECT_DIR}/reports/junit.xml" 
                }
            }
        }
        
        stage('Build Docker Image') {
            when {
                branch 'main'
            }
            steps {
                dir("${PROJECT_DIR}") { // <-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ dir()
                    script {
                        echo "ðŸ³ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°..."
                        sh 'docker build -t Scalar:${BUILD_ID} .'
                        
                        sh '''
                            if docker images | grep -q "Scalar"; then
                                echo "âœ… Docker Ð¾Ð±Ñ€Ð°Ð· ÑÐ¾Ð·Ð´Ð°Ð½"
                            else
                                echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Docker Ð¾Ð±Ñ€Ð°Ð·Ð°"
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
        
        // ... (ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ‚Ð°Ð´Ð¸Ð¸: Test Docker Image, Push to Registry, Deploy Notification)
        
        stage('Test Docker Image') {
            when {
                branch 'main'
            }
            steps {
                dir("${PROJECT_DIR}") { // <-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ dir()
                    script {
                        echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Docker Ð¾Ð±Ñ€Ð°Ð·..."
                        sh '''
                            docker rm -f scalar-test || true
                            docker run -d --name scalar-test Scalar:${BUILD_ID}
                            // ... (Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°)
                        '''
                    }
                }
            }
        }
        
        stage('Push to Registry') {
            when {
                branch 'main'
            }
            steps {
                dir("${PROJECT_DIR}") { // <-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ dir()
                    script {
                        // ... (Ð»Ð¾Ð³Ð¸ÐºÐ° Ñ withCredentials)
                    }
                }
            }
        }
        
        stage('Deploy Notification') {
            steps {
                echo "ðŸŽ‰ CI/CD Pipeline Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
            }
        }
    }
    
    post {
        // ...
        always {
            echo 'ðŸ“Š Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°'
            sh 'docker system prune -f || true'
        }
    }
}