pipeline {
    agent any
    
    environment {
        PYTHONUNBUFFERED = '1' 
        PROJECT_DIR = 'CI-CD'
    }
    
    stages {
        
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup Python Environment') {
            steps {
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
                        python3 --version
                        
                        if [ ! -d "venv" ]; then
                            python3 -m venv venv
                        fi
                    '''
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                dir("${PROJECT_DIR}") { 
                    sh '''
                        . venv/bin/activate
                        pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                dir("${PROJECT_DIR}") { 
                    sh '''
                        . venv/bin/activate
                        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ pytest..."
                        
                        mkdir -p reports
                        
                        python3 -m pytest tests/Test* --verbose --junitxml=reports/junit.xml
                    '''
                }
            }
            post {
                always {
                    junit "${PROJECT_DIR}/reports/junit.xml" 
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                dir("${PROJECT_DIR}") {
                    script {
                        echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
                        sh 'docker build -t scalar-pipeline:${BUILD_ID} .'
                        
                        sh '''
                            if docker images | grep -q "scalar-pipeline"; then
                                echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω"
                            else
                                echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞"
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
        
        stage('Test Docker Image') {
            steps {
                dir("${PROJECT_DIR}") {
                    echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º Docker –æ–±—Ä–∞–∑..."

                    sh '''
                        # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –æ—Å—Ç–∞–ª—Å—è
                        docker rm -f scalar-test || true

                        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∑–∞–º–µ–Ω–∏ scalar –Ω–∞ –∏–º—è –æ–±—Ä–∞–∑–∞, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª: scalar-pipeline)
                        docker run -d --name scalar-test scalar-pipeline:${BUILD_ID}

                        # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
                        sleep 5

                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç.
                        # –ò–º–µ–Ω–Ω–æ –∑–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ if/then/else/fi
                        if docker ps | grep -q "scalar-test"; then
                            echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"

                            # –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏
                            echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
                            docker logs scalar-test

                            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º
                            docker stop scalar-test
                            docker rm scalar-test

                            echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
                        else
                            echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
                            docker logs scalar-test || true
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('Push to Registry') {
            steps {
                dir("${PROJECT_DIR}") {
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh '''
                            echo "–û–±—Ä–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!"
                        '''
                    }
                }
            }
        }
        
        stage('Deploy Notification') {
            steps {
                echo "üéâ CI/CD Pipeline –∑–∞–≤–µ—Ä—à–µ–Ω!"
            }
        }
    }
    
    post {
        always {
            echo 'üìä –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'
            sh 'docker system prune -f || true'
        }
    }
}